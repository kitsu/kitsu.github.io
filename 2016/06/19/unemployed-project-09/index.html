<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="generator" content="Hugo 0.15" />
    <link rel="shortcut icon" href="/images/favicon.ico">
    
    <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Superfluous Comments" />
    <link href="/index.xml" rel="feed" type="application/rss+xml" title="Superfluous Comments" />
    
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    <script src="https://apis.google.com/js/platform.js" async defer>{lang: 'ja'}</script>
    
    <link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
    <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <title>Unemployed project - Knockout Templates | Superfluous Comments</title>
    <meta name="Description" content="Building modular chunks of HTML and reusing them with Knockout.
">
  </head>
  <body>
    <div id="wrap">
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-77704589-1', 'auto');
ga('send', 'pageview');
</script>

      <header class="site-header">
        <div class="site-header-left">
          <a class="site-header-title" href="http://kitsu.github.io/">Superfluous Comments</a>
        </div>
      </header>
      <div class="container">
        <div id="main">

<div class="article">
  <header>
    <div class="article-header">
      <h1>Unemployed project - Knockout Templates</h1>
      <div class="article-meta">
        <span class="posttime">2016/06/19</span>
        
<div class="tags">
  <ul>
    
    <li>
      <a href="/tags/csharp"><span></span>CSharp</a>
    </li>
    
    <li>
      <a href="/tags/aspnetcore"><span></span>AspNetCore</a>
    </li>
    
    <li>
      <a href="/tags/knockout"><span></span>Knockout</a>
    </li>
    
    <li>
      <a href="/tags/code"><span></span>code</a>
    </li>
    
  </ul>
</div>


      </div>
    </div>
  </header>
      
      <div class="adsense">
        <span class="sponsor-label">Sponsored link</span>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3013534986949508"
     data-ad-slot="2442045076"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
      </div>
      
  <div class="content">
    <p>Building modular chunks of HTML and reusing them with Knockout.</p>

<p><hr/><br/>
After deciding my app would need to render new log data on the fly, and after
reading some
<a href="http://www.onebigfluke.com/2015/01/experimentally-verified-why-client-side.html">interesting</a>
<a href="https://medium.com/google-developers/tradeoffs-in-server-side-and-client-side-rendering-14dad8d4ff8b#.x755manz0">posts</a>
on client-side rendering, I decided to replace my
server-side Razor templates with <a href="http://knockoutjs.com/documentation/template-binding.html">Knockout templates</a>.
This has simplified the shape of my application, and enabled me to do things
that were going to be messy in Razor, but getting there was not without
complications.</p>

<p>First I made some models that would contain the state for groups of logs. Here
are the important bits of the ListModel:
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">...</span>
<span style="color: #66d9ef">class</span> <span style="color: #a6e22e">ListModel</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #a6e22e">Logs</span>: <span style="color: #66d9ef">KnockoutObservableArray</span><span style="color: #f92672">&lt;</span><span style="color: #a6e22e">ActLogModel</span> <span style="color: #f92672">|</span> <span style="color: #a6e22e">ConLogModel</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">;</span>
    <span style="color: #a6e22e">Count</span>: <span style="color: #66d9ef">KnockoutComputed</span><span style="color: #f92672">&lt;</span><span style="color: #66d9ef">number</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">;</span>

    <span style="color: #66d9ef">constructor</span><span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Logs</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">ko</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">observableArray</span><span style="color: #f8f8f2">([]);</span>
        <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Count</span> <span style="color: #f92672">=</span> <span style="color: #a6e22e">ko</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">computed</span><span style="color: #f8f8f2">(()</span> <span style="color: #f92672">=&gt;</span> <span style="color: #f8f8f2">{</span> <span style="color: #66d9ef">return</span> <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Logs</span><span style="color: #f8f8f2">().</span><span style="color: #a6e22e">length</span> <span style="color: #f8f8f2">});</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">updateList</span> <span style="color: #f92672">=</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">result</span>: <span style="color: #66d9ef">any</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">void</span> <span style="color: #f92672">=&gt;</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #75715e">// Callback for ajax log request</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">result</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">success</span> <span style="color: #f92672">===</span> <span style="color: #66d9ef">true</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
           <span style="color: #a6e22e">console</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">(</span><span style="color: #960050; background-color: #1e0010">`</span><span style="color: #a6e22e">Got</span> <span style="color: #a6e22e">$</span><span style="color: #f8f8f2">{</span><span style="color: #a6e22e">result</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">data</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">length</span><span style="color: #f8f8f2">}</span> <span style="color: #a6e22e">Logs</span><span style="color: #f92672">!</span><span style="color: #960050; background-color: #1e0010">`</span><span style="color: #f8f8f2">);</span>
            <span style="color: #66d9ef">for</span> <span style="color: #f8f8f2">(</span><span style="color: #66d9ef">let</span> <span style="color: #a6e22e">log</span> <span style="color: #a6e22e">of</span> <span style="color: #a6e22e">result</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">data</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
                <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">hasOwnProperty</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;Location&quot;</span><span style="color: #f8f8f2">))</span> <span style="color: #f8f8f2">{</span>
                    <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">addAct</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">);</span>
                <span style="color: #f8f8f2">}</span> <span style="color: #66d9ef">else</span> <span style="color: #f8f8f2">{</span>
                    <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">addCon</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">);</span>
                <span style="color: #f8f8f2">}</span>
            <span style="color: #f8f8f2">}</span>
        <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">addAct</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span>: <span style="color: #66d9ef">any</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">void</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #75715e">// Build new model for this log</span>
        <span style="color: #66d9ef">let</span> <span style="color: #a6e22e">actModel</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #a6e22e">ActLogModel</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">LogDate</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">slice</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2">));</span>
        <span style="color: #f8f8f2">...</span>
        <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Logs</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">push</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">actModel</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">addCon</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span>: <span style="color: #66d9ef">any</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">void</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #75715e">// Build new model for this log</span>
        <span style="color: #66d9ef">let</span> <span style="color: #a6e22e">conModel</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #a6e22e">ConLogModel</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">LogDate</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">slice</span><span style="color: #f8f8f2">(</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">,</span> <span style="color: #ae81ff">10</span><span style="color: #f8f8f2">));</span>
        <span style="color: #f8f8f2">...</span>
        <span style="color: #66d9ef">this</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">Logs</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">push</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">conModel</span><span style="color: #f8f8f2">);</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">logTemplate</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span>: <span style="color: #66d9ef">ActLogModel</span> <span style="color: #f92672">|</span> <span style="color: #a6e22e">ConLogModel</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">string</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #75715e">// Used to determine template name for existing logs</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span> <span style="color: #66d9ef">instanceof</span> <span style="color: #a6e22e">ActLogModel</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #e6db74">&#39;ActLogTemp&#39;</span><span style="color: #f8f8f2">;</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">return</span> <span style="color: #e6db74">&#39;ConLogTemp&#39;</span><span style="color: #f8f8f2">;</span>
    <span style="color: #f8f8f2">}</span>

    <span style="color: #a6e22e">editTemplate</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span>: <span style="color: #66d9ef">ActLogModel</span> <span style="color: #f92672">|</span> <span style="color: #a6e22e">ConLogModel</span><span style="color: #f8f8f2">)</span><span style="color: #f92672">:</span> <span style="color: #66d9ef">string</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #75715e">// Used to determine edit form template for existing logs</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(</span><span style="color: #a6e22e">log</span> <span style="color: #66d9ef">instanceof</span> <span style="color: #a6e22e">ActLogModel</span><span style="color: #f8f8f2">)</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #e6db74">&#39;LogActTemp&#39;</span><span style="color: #f8f8f2">;</span>
        <span style="color: #f8f8f2">}</span>
        <span style="color: #66d9ef">return</span> <span style="color: #e6db74">&#39;LogConTemp&#39;</span><span style="color: #f8f8f2">;</span>
    <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">...</span>
</pre></div>
</p>

<p>The model is then bound in a script tag at the bottom of the page:
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">script</span> <span style="color: #a6e22e">type</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text/javascript&quot;</span><span style="color: #f8f8f2">&gt;</span>
    <span style="color: #a6e22e">$</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">function</span> <span style="color: #f8f8f2">()</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">...</span>
        <span style="color: #75715e">// Bind list model to view</span>
        <span style="color: #f8f8f2">window.</span><span style="color: #a6e22e">listModel</span> <span style="color: #f92672">=</span> <span style="color: #66d9ef">new</span> <span style="color: #a6e22e">ListModel</span><span style="color: #f8f8f2">()</span>
        <span style="color: #a6e22e">$</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">getJSON</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;/LogLists&quot;</span><span style="color: #f8f8f2">).</span><span style="color: #a6e22e">done</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">listModel</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">updateList</span><span style="color: #f8f8f2">)</span>
        <span style="color: #a6e22e">ko</span><span style="color: #f8f8f2">.</span><span style="color: #a6e22e">applyBindings</span><span style="color: #f8f8f2">(</span><span style="color: #a6e22e">listModel</span><span style="color: #f8f8f2">,</span> <span style="color: #a6e22e">$</span><span style="color: #f8f8f2">(</span><span style="color: #e6db74">&quot;#LogList&quot;</span><span style="color: #f8f8f2">)[</span><span style="color: #ae81ff">0</span><span style="color: #f8f8f2">]);</span>
    <span style="color: #f8f8f2">});</span>
<span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">script</span><span style="color: #f8f8f2">&gt;</span>
</pre></div>
</p>

<p>Here is where the model is bound:
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span>...
<span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">div</span> <span style="color: #a6e22e">id</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;LogList&quot;</span><span style="color: #f8f8f2">&gt;</span>
    <span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">h4</span> <span style="color: #a6e22e">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text-center&quot;</span><span style="color: #f8f8f2">&gt;</span>
        <span style="color: #75715e">&lt;!-- There will be some filtering controls here --&gt;</span>
        <span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">span</span> <span style="color: #a6e22e">data-bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text: Count&quot;</span><span style="color: #f8f8f2">&gt;&lt;/</span><span style="color: #f92672">span</span><span style="color: #f8f8f2">&gt;</span> Logs
    <span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">h4</span><span style="color: #f8f8f2">&gt;</span>
    <span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">div</span> <span style="color: #a6e22e">data-bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;template: {name: logTemplate, foreach: Logs}&quot;</span><span style="color: #f8f8f2">&gt;&lt;/</span><span style="color: #f92672">div</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">div</span><span style="color: #f8f8f2">&gt;</span>
...
</pre></div>
</p>

<p>I thought it was interesting that you can actually include html in a script tag!
Here is the entire Activity Log Template:
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">script</span> <span style="color: #a6e22e">type</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text/html&quot;</span> <span style="color: #a6e22e">id</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;ActLogTemp&quot;</span><span style="color: #f8f8f2">&gt;</span>
    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;attr: {id:&#39;log-&#39; + Id()}&quot;</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;panel panel-default&quot;</span><span style="color: #f92672">&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;panel-heading&quot;</span> <span style="color: #a6e22e">role</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;tab&quot;</span>
             <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;attr: {id: &#39;head-&#39; + Id()}&quot;</span><span style="color: #f92672">&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">h4</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;panel-title pull-left&quot;</span><span style="color: #f92672">&gt;</span>
                <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">a</span> <span style="color: #a6e22e">role</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;button&quot;</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">toggle</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;collapse&quot;</span>
                   <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;attr: {href: &#39;#body-&#39; + Id(),</span>
<span style="color: #e6db74">                                     &#39;aria-controls&#39;: &#39;body-&#39; + Id()}&quot;</span>
                   <span style="color: #a6e22e">aria</span><span style="color: #f92672">-</span><span style="color: #a6e22e">expanded</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;false&quot;</span>
                   <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;btn&quot;</span><span style="color: #f92672">&gt;</span>
                    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">span</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;label label-default&quot;</span>
                          <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text: LogDate&quot;</span><span style="color: #f92672">&gt;</span>
                    <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/span&gt;</span>
                      <span style="color: #a6e22e">Activity</span> <span style="color: #a6e22e">at</span>
                    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">span</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text: Location&quot;</span><span style="color: #f92672">&gt;&lt;</span><span style="color: #960050; background-color: #1e0010">/span&gt;</span>
                    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">span</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;glyphicon glyphicon-menu-down&quot;</span><span style="color: #f92672">&gt;&lt;</span><span style="color: #960050; background-color: #1e0010">/span&gt;</span>
                <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/a&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/h4&gt;</span>
            <span style="color: #75715e">&lt;!--</span> <span style="color: #a6e22e">Nested</span> <span style="color: #a6e22e">template</span><span style="color: #f92672">!</span> <span style="color: #f92672">--&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;template: {name: &#39;DeletePanel&#39;}&quot;</span><span style="color: #f92672">&gt;&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;clearfix&quot;</span><span style="color: #f92672">&gt;&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;panel-collapse collapse&quot;</span> <span style="color: #a6e22e">role</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;tabpanel&quot;</span>
             <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;attr: {id: &#39;body-&#39; + Id(),</span>
<span style="color: #e6db74">                               &#39;aria-labelledby&#39;: &#39;head-&#39; + Id()}&quot;</span><span style="color: #f92672">&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;panel-body&quot;</span><span style="color: #f92672">&gt;</span>
                <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">dl</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;dl-horizontal&quot;</span><span style="color: #f92672">&gt;</span>
                    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">dt</span><span style="color: #f92672">&gt;</span><span style="color: #a6e22e">Description</span><span style="color: #f92672">:&lt;</span><span style="color: #960050; background-color: #1e0010">/dt&gt;</span>
                    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">dd</span><span style="color: #f92672">&gt;&lt;</span><span style="color: #a6e22e">pre</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text: Description&quot;</span><span style="color: #f92672">&gt;&lt;</span><span style="color: #960050; background-color: #1e0010">/pre&gt;&lt;/dd&gt;</span>
                <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/dl&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
    <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
<span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">script</span><span style="color: #f8f8f2">&gt;</span>
</pre></div>
</p>

<p>Both of the log types share a common UI component with the edit &amp; delete
buttons. The delete button is a toggle for a collapsed panel to confirm
deletion. I had a lot of trouble getting the DeletePanel template to work, it
seemed like the model wasn't getting bound. I was blaming the nested template
for quite a while, but when I added some bound elements to debug I found the
model was fine. I was just about to paste the template back into both log
templates when I figured it out:
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">script</span> <span style="color: #a6e22e">type</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text/html&quot;</span> <span style="color: #a6e22e">id</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;DeletePanel&quot;</span><span style="color: #f8f8f2">&gt;</span>
    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;btn-group pull-right&quot;</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">toggle</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;buttons&quot;</span><span style="color: #f92672">&gt;</span>
        <span style="color: #f8f8f2">...</span>
        <span style="color: #75715e">&lt;!--</span> <span style="color: #a6e22e">Note</span> <span style="color: #a6e22e">the</span> <span style="color: #a6e22e">missing</span> <span style="color: #a6e22e">brace</span> <span style="color: #66d9ef">in</span> <span style="color: #a6e22e">the</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">!</span> <span style="color: #f92672">--&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">a</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;btn btn-sm btn-danger&quot;</span> <span style="color: #a6e22e">role</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;button&quot;</span>
           <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">toggle</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;collapse&quot;</span> <span style="color: #a6e22e">aria</span><span style="color: #f92672">-</span><span style="color: #a6e22e">expanded</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;false&quot;</span> <span style="color: #a6e22e">aria</span><span style="color: #f92672">-</span><span style="color: #a6e22e">controls</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;DeletePrompt&quot;</span>
           <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;attr: {&#39;data-target&#39;: &#39;#delete-&#39; + Id()&quot;</span><span style="color: #f92672">&gt;</span>
            <span style="color: #a6e22e">Delete</span>
        <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/a&gt;</span>
    <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
<span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">script</span><span style="color: #f8f8f2">&gt;</span>
</pre></div>
</p>

<p>I have no idea how the code worked before I factored it into its own template,
it must not have. After adding the missing <code>}</code> everything worked.</p>

<p>In the nested DeletePanel template I added even another nested template for the
edit form. Actually the edit form <em>is</em> the log add form. It took several tries
to make the form templates reusable, but after my DeletePanel success I knew it
would work. At first I just reused the log form templates unchanged, and they
actually worked - the fields all populated from the model and clicking the
submit button did <em>something</em>. That something was re-adding the edited log as a
new entry.</p>

<p>The add forms use a Knockout <code>submit</code> binding to tie the submit event to the add
method of a log. To allow setting the submit callback I had to move the form
tags outside of the template. To fix the button text I had to change the data
member of the template data-bind to include the action name. Because setting the
data member replaces the binding context I also had to pass the model explicitly.</p>

<p>The next problem I had was that when the submit callback is called <code>this</code> isn't
the model. I tried using a Typescript fat arrow <code>=&gt;</code>, but then <code>this</code> was bound
to the container - probably because of where the method was defined. The
solution was to use the method's bind method in the data-bind. Here are the
bits:</p>

<p><div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">&lt;!-- In the page html for add form --&gt;</span>
<span style="color: #75715e">&lt;!-- Note here the model is the AdditionModel which contains the act &amp; con --&gt;</span>
<span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">form</span> <span style="color: #a6e22e">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;form-horizontal&quot;</span> <span style="color: #a6e22e">data-bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;submit: actModel.addLog.bind(actModel)&quot;</span><span style="color: #f8f8f2">&gt;</span>
    <span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">div</span> <span style="color: #a6e22e">data-bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;template: {name: &#39;LogActTemp&#39;,</span>
<span style="color: #e6db74">                               data: {actionName: &#39;Add Log&#39;,</span>
<span style="color: #e6db74">                                      model: actModel}}&quot;</span><span style="color: #f8f8f2">&gt;&lt;/</span><span style="color: #f92672">div</span><span style="color: #f8f8f2">&gt;</span>
<span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">form</span><span style="color: #f8f8f2">&gt;</span>

<span style="color: #75715e">&lt;!-- The inserted Template --&gt;</span>
<span style="color: #f8f8f2">&lt;</span><span style="color: #f92672">script</span> <span style="color: #a6e22e">type</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text/html&quot;</span> <span style="color: #a6e22e">id</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;LogActTemp&quot;</span><span style="color: #f8f8f2">&gt;</span>
    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;form-group&quot;</span><span style="color: #f92672">&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">label</span> <span style="color: #66d9ef">for</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;LogActDate&quot;</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;col-md-1 control-label&quot;</span><span style="color: #f92672">&gt;</span><span style="color: #f8f8f2">Date</span><span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/label&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;col-md-4&quot;</span><span style="color: #f92672">&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">input</span> <span style="color: #a6e22e">type</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;date&quot;</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;form-control&quot;</span> <span style="color: #a6e22e">id</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;LogActDate&quot;</span>
                   <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;value: model.LogDate&quot;</span> <span style="color: #f92672">/&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
        <span style="color: #f8f8f2">...</span>
    <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
    <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;form-group&quot;</span><span style="color: #f92672">&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">div</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;col-md-2 col-md-offset-10&quot;</span><span style="color: #f92672">&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #a6e22e">button</span> <span style="color: #a6e22e">type</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;submit&quot;</span> <span style="color: #66d9ef">class</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;form-control btn-primary&quot;</span>
                    <span style="color: #a6e22e">id</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;LogActSubmit&quot;</span> <span style="color: #a6e22e">data</span><span style="color: #f92672">-</span><span style="color: #a6e22e">bind</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;text: actionName&quot;</span><span style="color: #f92672">&gt;</span>
            <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/button&gt;</span>
        <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
    <span style="color: #f92672">&lt;</span><span style="color: #960050; background-color: #1e0010">/div&gt;</span>
<span style="color: #f8f8f2">&lt;/</span><span style="color: #f92672">script</span><span style="color: #f8f8f2">&gt;</span>
</pre></div>
</p>

<p>All together it looks like a lot, but with the templates stored away in a Razor
partial view and the Typescript in its own file everything cleaned up
nicely. Adding the edit forms was just a couple lines of code once the template
was sorted.</p>

<p>I had to do a little work to get the editing working on the server side. The
main problem was controller data binding fails when passing a log id in
json. The solution was passing the id in the url:
<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #f8f8f2">...</span>
<span style="color: #75715e">// POST: /LogLists/EditContact/{id}</span>
<span style="color: #a6e22e">[HttpPost]</span>
<span style="color: #66d9ef">public</span> <span style="color: #66d9ef">async</span> <span style="color: #f8f8f2">Task&lt;JsonResult&gt;</span> <span style="color: #f8f8f2">EditContact(Guid</span> <span style="color: #f8f8f2">Id,</span> <span style="color: #f8f8f2">[FromBody]</span> <span style="color: #f8f8f2">ContactLog</span> <span style="color: #f8f8f2">log)</span>
<span style="color: #f8f8f2">{</span>
    <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(ModelState.IsValid)</span>
    <span style="color: #f8f8f2">{</span>
        <span style="color: #f8f8f2">log.Id</span> <span style="color: #f8f8f2">=</span> <span style="color: #f8f8f2">Id;</span>
        <span style="color: #66d9ef">var</span> <span style="color: #f8f8f2">success</span> <span style="color: #f8f8f2">=</span> <span style="color: #66d9ef">await</span> <span style="color: #f8f8f2">_logRepository.UpdateAsync(log);</span>
        <span style="color: #66d9ef">if</span> <span style="color: #f8f8f2">(success)</span>
        <span style="color: #f8f8f2">{</span>
            <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">Json</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">{</span> <span style="color: #f8f8f2">success</span> <span style="color: #f8f8f2">=</span> <span style="color: #66d9ef">true</span> <span style="color: #f8f8f2">});</span>
        <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span>
    <span style="color: #66d9ef">return</span> <span style="color: #a6e22e">Json</span><span style="color: #f8f8f2">(</span><span style="color: #66d9ef">new</span> <span style="color: #f8f8f2">{</span> <span style="color: #f8f8f2">success</span> <span style="color: #f8f8f2">=</span> <span style="color: #66d9ef">false</span> <span style="color: #f8f8f2">});</span>
<span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">...</span>
</pre></div>
</p>

  </div>
  <footer>
    <div class="article-footer">
      
<div class="tags">
  <ul>
    
    <li>
      <a href="/tags/csharp"><span></span>CSharp</a>
    </li>
    
    <li>
      <a href="/tags/aspnetcore"><span></span>AspNetCore</a>
    </li>
    
    <li>
      <a href="/tags/knockout"><span></span>Knockout</a>
    </li>
    
    <li>
      <a href="/tags/code"><span></span>code</a>
    </li>
    
  </ul>
</div>


      
      <div class="adsense">
        <span class="sponsor-label">Sponsored link</span>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3013534986949508"
     data-ad-slot="2442045076"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
      </div>
      
      
<div id="share-buttons">
  <ul>
    
    
    
    
    <li>
      <div class="g-plusone" data-size="medium"></div>
    </li>
    
    
  </ul>
</div>


      <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'SuperfComs';
    var disqus_identifier = 'http:\/\/kitsu.github.io\/2016\/06\/19\/unemployed-project-09\/';
    var disqus_title = 'Unemployed project - Knockout Templates';
    var disqus_url = 'http:\/\/kitsu.github.io\/2016\/06\/19\/unemployed-project-09\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      <div id="pagenavigation-next-prev">
        
        <div id="pagenavigation-next">
          <span class="pagenav-label">Previous</span>
          <a href="http://kitsu.github.io/2016/06/17/unemployed-project-08/">Unemployed project - Serialization</a>
        </div>
        
        
        <div id="pagenavigation-prev">
          <span class="pagenav-label">Next</span>
          <a href="http://kitsu.github.io/2016/06/21/unemployed-project-10/">Unemployed project - Migration</a>
        </div>
        
      </div>
      
    </div>
  </footer>
</div>
        </div>
        <div class="sidebar">
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Author</span>
    </div>
    <div id="author">
      <span>Ed Blake</span>
      <div>
        
        
        <a href="https://plus.google.com/118323029386640613972"><i class="fa fa-google-plus-square fa-2x" aria-hidden="true"></i></a>
        
        
        <a href="https://github.com/kitsu"><i class="fa fa-github-square fa-2x" aria-hidden="true"></i></a>
        
        
        <a href="https://www.linkedin.com/in/edward-blake-b3601411b"><i class="fa fa-linkedin-square fa-2x" aria-hidden="true"></i></a>
        
        
        <a href="https://stackoverflow.com/users/770443"><i class="fa fa-stack-overflow fa-2x" aria-hidden="true"></i></a>
        
      </div>
    </div>
  </div>
  
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Categories</span>
    </div>
    <div class="categories">
      <ul>
        
        <li>
          <a href="/categories/blog"><span></span>blog (3)</a>
        </li>
        
        <li>
          <a href="/categories/development"><span></span>development (31)</a>
        </li>
        
        <li>
          <a href="/categories/hacks"><span></span>hacks (4)</a>
        </li>
        
        <li>
          <a href="/categories/personal"><span></span>personal (3)</a>
        </li>
        
      </ul>
    </div>
  </div>
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>RSS</span>
    </div>
    <div id="rss">
      <a href="/index.xml" type="application/rss+xml" target="_blank">
        <i class="fa fa-rss-square fa-2x" aria-hidden="true"></i>
      </a>
    </div>
  </div>
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Sponsored link</span>
    </div>
    <div class="adsense">
      <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<ins class="adsbygoogle"
     style="display:inline-block;width:300px;height:600px"
     data-ad-client="ca-pub-3013534986949508"
     data-ad-slot="9965311870"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    </div>
  </div>
  
</div>

      </div>
      <footer>
        <div id="site-footer-wrap">
          <div id="site-footer">
            <span>Powered by <a href="https://gohugo.io/">Hugo</a>.</span>
            <span>
              
              © 2015 Ed Blake
              
           </span>
           <span id="copyleft">
              <a rel="license"
                 href="http://creativecommons.org/licenses/by-sa/4.0/">
                <img alt="Creative Commons License" style="border-width:0"
                     src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" />
              </a>
            </span>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>

